const DOM = {};
const AppState = { dream: '', mood: '', style: 'psychology', currentContent: '', records: [] };
function initDOM() { DOM.dreamInput = document.getElementById('dream-input'); DOM.mood = document.getElementById('mood'); DOM.style = document.getElementById('style'); DOM.btnInterpret = document.getElementById('btn-interpret'); DOM.resultArea = document.getElementById('result-area'); DOM.content = document.getElementById('content'); DOM.historyPanel = document.getElementById('history-panel'); DOM.historyList = document.getElementById('history-list'); DOM.historyOverlay = document.getElementById('history-overlay'); DOM.settingsModal = document.getElementById('settings-modal'); DOM.toast = document.getElementById('toast'); }
function initEvents() {
    DOM.dreamInput.addEventListener('input', () => AppState.dream = DOM.dreamInput.value);
    DOM.mood.addEventListener('change', () => AppState.mood = DOM.mood.value);
    DOM.style.addEventListener('change', () => AppState.style = DOM.style.value);
    DOM.btnInterpret.addEventListener('click', interpret);
    document.getElementById('btn-save').addEventListener('click', saveRecord);
    document.getElementById('btn-history').addEventListener('click', () => { DOM.historyPanel.classList.add('open'); DOM.historyOverlay.classList.remove('hidden'); });
    document.getElementById('btn-close-history').addEventListener('click', closeHistory); DOM.historyOverlay.addEventListener('click', closeHistory);
    document.getElementById('btn-settings').addEventListener('click', () => { DOM.settingsModal.classList.add('show'); loadSettings(); });
    document.getElementById('btn-close-settings').addEventListener('click', () => DOM.settingsModal.classList.remove('show'));
    document.getElementById('btn-cancel-settings').addEventListener('click', () => DOM.settingsModal.classList.remove('show'));
    document.getElementById('btn-save-settings').addEventListener('click', saveSettings);
    document.querySelectorAll('.example-btn').forEach(btn => btn.addEventListener('click', () => loadExample(btn.dataset.example)));
}
const EXAMPLES = { fly: { dream: 'æˆ‘æ¢¦è§è‡ªå·±åœ¨å¤©ç©ºä¸­è‡ªç”±é£ç¿”ï¼Œæ„Ÿè§‰éå¸¸è½»ç›ˆè‡ªåœ¨ï¼Œå¯ä»¥çœ‹åˆ°ä¸‹é¢çš„åŸå¸‚å’Œå±±å·...', mood: 'happy' }, fall: { dream: 'æˆ‘æ¢¦è§è‡ªå·±ä»å¾ˆé«˜çš„åœ°æ–¹æ‰ä¸‹å»ï¼Œä¸€ç›´åœ¨å è½ï¼Œéå¸¸å®³æ€•ï¼Œå¿«è¦è½åœ°çš„æ—¶å€™å°±é†’äº†...', mood: 'scared' }, chase: { dream: 'æˆ‘æ¢¦è§è¢«ä¸æ˜çš„ä¸œè¥¿è¿½èµ¶ï¼Œä¸åœåœ°è·‘ä½†æ€»æ˜¯è·‘ä¸å¿«ï¼Œå¾ˆç´§å¼ ...', mood: 'anxious' }, teeth: { dream: 'æˆ‘æ¢¦è§è‡ªå·±çš„ç‰™é½¿ä¸€é¢—ä¸€é¢—æ‰è½ï¼Œæ„Ÿè§‰å¾ˆæ…Œå¼ ...', mood: 'anxious' } };
function loadExample(key) { const ex = EXAMPLES[key]; if (!ex) return; DOM.dreamInput.value = ex.dream; AppState.dream = ex.dream; DOM.mood.value = ex.mood; AppState.mood = ex.mood; showToast('info', 'å·²å¡«å…¥', 'ç‚¹å‡»è§£è¯»æ¢¦å¢ƒ'); }
async function interpret() { if (!AppState.dream.trim()) { showToast('warning', 'è¯·æè¿°æ¢¦å¢ƒ', ''); return; } DOM.resultArea.classList.remove('hidden'); DOM.content.innerHTML = ''; AppState.currentContent = ''; await AIService.interpret(AppState.dream, AppState.mood, AppState.style, (t) => { AppState.currentContent += t; DOM.content.innerHTML = formatContent(AppState.currentContent); }, () => showToast('success', 'è§£è¯»å®Œæˆ', ''), (e) => showToast('error', 'è§£è¯»å¤±è´¥', e.message)); }
function formatContent(text) { return text.replace(/^## (.+)$/gm, '<h2 class="text-lg font-bold text-purple-300 mt-5 mb-2">$1</h2>').replace(/\*\*(.+?)\*\*/g, '<strong class="text-indigo-300">$1</strong>').replace(/\n/g, '<br>'); }
async function saveRecord() { if (!AppState.currentContent) { showToast('warning', 'æ— å†…å®¹', ''); return; } const record = { dream: AppState.dream.substring(0, 50) + '...', content: AppState.currentContent }; const result = await StorageService.saveRecord(record); if (result.success) { showToast('success', 'å·²ä¿å­˜', ''); loadHistory(); } }
async function loadHistory() { AppState.records = await StorageService.getRecords(); renderHistory(); }
function renderHistory() { if (AppState.records.length === 0) { DOM.historyList.innerHTML = '<p class="text-purple-400/50 text-sm text-center">æš‚æ— è®°å½•</p>'; return; } DOM.historyList.innerHTML = AppState.records.map(r => `<div class="p-3 bg-purple-800/30 rounded-xl"><div class="font-medium text-purple-200 text-ellipsis overflow-hidden whitespace-nowrap">ğŸŒ™ ${r.dream}</div><div class="text-xs text-purple-400/70 mt-1">${new Date(r.createdAt).toLocaleDateString()}</div></div>`).join(''); }
function closeHistory() { DOM.historyPanel.classList.remove('open'); DOM.historyOverlay.classList.add('hidden'); }
function loadSettings() { const c = AIService.getModelConfig() || {}; document.getElementById('api-url').value = c.apiUrl || ''; document.getElementById('api-key').value = c.apiKey || ''; document.getElementById('model-name').value = c.modelName || ''; }
function saveSettings() { const c = { apiUrl: document.getElementById('api-url').value.trim(), apiKey: document.getElementById('api-key').value.trim(), modelName: document.getElementById('model-name').value.trim() || 'GLM-4-Flash' }; if (!c.apiUrl || !c.apiKey) { showToast('warning', 'è¯·å¡«å†™å®Œæ•´', ''); return; } AIService.saveModelConfig(c); DOM.settingsModal.classList.remove('show'); showToast('success', 'é…ç½®å·²ä¿å­˜', ''); }
function showToast(type, title, message) { const icons = { success: 'âœ…', error: 'âŒ', warning: 'âš ï¸', info: 'â„¹ï¸' }; const colors = { success: 'bg-green-500', error: 'bg-red-500', warning: 'bg-yellow-500', info: 'bg-purple-500' }; document.getElementById('toast-icon').className = `w-8 h-8 rounded-full flex items-center justify-center ${colors[type]}`; document.getElementById('toast-icon').textContent = icons[type]; document.getElementById('toast-title').textContent = title; document.getElementById('toast-message').textContent = message; DOM.toast.classList.remove('hidden'); setTimeout(() => DOM.toast.classList.add('hidden'), 3000); }
async function init() { initDOM(); initEvents(); await loadHistory(); const config = await AIService.initConfig(); if (!config) setTimeout(() => { DOM.settingsModal.classList.add('show'); showToast('info', 'æ¬¢è¿ä½¿ç”¨', 'è¯·é…ç½® AI æ¨¡å‹'); }, 500); }
document.addEventListener('DOMContentLoaded', init);
